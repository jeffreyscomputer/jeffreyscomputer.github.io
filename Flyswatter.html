<!DOCTYPE html>
<html>
<head>
	<title>Flyswatter</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="css/normalize.css">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:300,400,700" rel="stylesheet">
	<link rel="stylesheet" href="css/style.css">
  <script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

</head>
<body>
		<div class="container">
			<p>
				<a href="index.html">
				Main Index</a>
			</p>
      <h1>High Voltage Insect Zapper</h1>
      <p>This is one of those simple circuits for which can be found a lot of very poor explanations. I took one apart and did some looking and testing--now I have the feeling that I have something to say about it. In fact, I have determined empirically that I have far too much to say about it, but what can you do?</p>
      <h2>Initial Measurements</h2>
      <p>The first thing we want do is to measure the output voltage. Before that, however, we should have a general idea of the magnitude of the output so we don't accidentally damage a meter. It is useful to remember that the dielectric strength of air is around 3kV per mm. Since the electrode screens on the device are separated by only a couple millimeters, and no arcing occurs spontaneously, we know we aren't dealing with 10's of thousands of volts. But a value of a couple thousand would surprise no one. Since we don't want to try to measure anything bigger than 1000V with the multimeter, we add a 1Meg resistor in series with the 10Meg load resistor. Measuring across the 1Meg resistor shows a voltage of 165V--ignoring internal resistance of the DMM for the foreseeable future--the full output voltage is around 1.8kV.</p>
      <h2>Schematic Extraction</h2>
      <p>Next we want to extract a schematic representation from the physical circuit. This can be accomplished readily using a combination of visual inspection and measurements of resistances and diode drops. Just looking at the PCB inside of one of these devices (purchased from Harbor Freight) reveals three important parts of the circuit: (1) Some type of transformer with 5 pins, (2) Some type of 3 terminal TO-92 package device -- revealed to be an NPN transistor upon reading its label, and (3) A string of capacitors and diodes which is most definitely a voltage multiplier. </p>
			<p>So what do we have? A self oscillating DC-DC converter of a yet unknown topology. All we have to do to complete the picture is determine the pinouts of the transformer and transistor.</p>
      <h4>Digression on the Transformer</h4>
      <p>This section is kind of long -- you can go ahead and skip to the section of your choice if you don't care about my transformer journey. Also if you are a mathematician, my "calculations" might appear appallingly crude. In my defense, I had no measurement tools other than my eyes available when I did this analysis, and so cannot justify a much more rigourous treatment. Nevertheless, we proceed.</p>
      <p>Just by looking, we can see how all these parts are connected. Though we don't know the configuration of the transformer yet, we know that it has the following pin connections: one directly to the 3V supply, one to the 3V supply through a 3k3 resistor, one to the first capacitor of the voltage multiplier, and two to the transistor. Next, using the multimeter to measure the transformer's pin to pin resistances, we are further able to determine a probable configuration. Below is a summary of those measurements:</p>
      <img class="displayed" src="images/Flyswatter-transformer-01.PNG" />
      <p>As seen in the graphic, the resistance tests determine the electrical connections of the coils. This doesn't mean a whole lot on its own, but combined with physical measurements of the core and knowledge of the resistivity of the wire used, we can estimate the length of the wires making up each coil, and thus the number of turns, and the inductance.</p>
      <p>The coils between pins 3 and 4, and pins 1 and 5 appear to be wound with the same gauge wire, which to me looks to be no smaller than 30AWG or so. The other coil, between 3 and 2 is unfortunately too hard to see from the outside, so I can't tell. But we can use other aspects of the transformer geometry to determine what we have.</p>
      <p>Let's take a leap and assume that most of the volume of the transformer windings is taken up by the 250 ohm winding, and further that the ratio of copper to empty space is the ratio of the area of a circle with diameter a to a square with side length a, that is pi/4. This is the approximate situation:</p>
      <img class="displayed" src="images/Flyswatter-coil-volume.PNG" />
      <p>Where:</p>
      \[V_{copper} \approx l \cdot(W^2 - W_c^2)\cdot\frac{\pi}{4}\]
      <p>The length of the copper wire can be determined if the cross sectional area is known:</p>
      <img class="displayed" src="images/Flyswatter-wire-volume.PNG" />
      <p>with</p>
      \[L = \frac{V}{A}\]
      <p>And with resistance defined as:</p>
      \[R = \rho \frac{L}{A}\]
      <p>Combining the second two equations gives R in terms of V and A. Expressing V in terms of the coil and core geometry yields an expression for A:</p>
      \[R = \rho \frac{V/A}{A} = \rho \frac{V}{A^2} = \rho \frac{\pi l\cdot (W^2 - W_c^2)}{4 A^2}\]
      \[\therefore A = \sqrt{\frac{\rho \pi l \cdot(W^2-W_c^2)}{4 R}}\]
      <p>Further, an expression for the diameter of the wire can be obtained:</p>
      \[D = \left [ \frac{4 \rho l \cdot(W^2-W_c^2)}{\pi R}\right ]^{1/4}\]
      <p>That's nice, but it's probably a better idea to just use Matlab. The script below helps determine (among other things) the approximate values for wire gauge, number of turns and inductance:</p>
      <img class="displayed" src="images/Flyswatter-coil-calc-matlab.PNG" />
      <p>Note that I totally guessed the relative permeability of the ferrite core -- it could be anything from like 20 up to several hundred. At any rate, this gives us an approximate wire gauge of 43AWG, a turn count of like 1500, and an inductance of like 750mH. There is a lot that can make this not true -- but it at least gives us an idea that the inductance of that coil is in the 100s of mH range, to maybe several Henries.</p>
      <p>The other coils then, which appear to be made of the same wire gauge, with the same series resistance, must have similar characteristics. Now, for an increase in AWG # by 10, the increase in resistance is 10 times. That's an approximately 26% increase in resistance per step in AWG. This means 43 AWG should have a resistance approximately 20 times that of 30AWG. Since 43 AWG wire has about 2 ohms per foot resistance, 30AWG is expected to have around 100m ohms for the same length. Since the mean coil length is near an inch, that translates to 12 or so turns for every 100m ohms. This implies 60 turns if we are to trust our 500m ohm resistance measurement... which I don't. However, it is also unknown what the actual length of each turn is, so I'm postulating we have anywhere from 10 to 100 turns. That gives an inductance range from like 30uH to 3mH.</p>
      <p>Note that I am ignoring any nonlinearity of the core material, which is generally unwise. But remember, All we are trying to do at this point is investigate why this thing works -- if it turns out that the simulation doesn't work, it is likely that transformer saturation is necessary to operation. More on this later.</p>
      <h4>The Transistor</h4>
      <p>Lucky for us, the transistor had a legible label on it -- however, we could have determined its pinout by measuring diode drops between pins, assuming none of the other diodes on board were connected in any way that could cause deception. By looking at the device datasheet, it is clear that some behavior deviates from the SPICE default NPN transistor. Now, I could go into another digression about this, but I don't want to do that exactly. Suffice to say that the important parameters were the forward current gain, BE and CB capacitance, early voltage and high current beta roll off. Anyway, in the next section is a picture of the LT Spice schematic, showing how the switch is actually connected.</p>
			<h4>The Voltage Multiplier</h4>
			The voltage multiplier section has 4 capacitors and 4 diodes, arranged like this:</p>
			<img class="displayed" src="images/Flyswatter-voltage-multiplier.PNG" />
			<p>A half wave "voltage doubler" is typically shown with two capacitors and two diodes driven by an AC source v(t)=Asin(wt), where the amplitude A is half of the peak to peak voltage of the AC signal. Invoking the picture above, we say C1 and D1 form a voltage clamp, the output of which approaches v(t)=Asin(wt)+A. Then C2 and D2 form a peak detector (or half wave rectifier if a load is connected across C2), with an output voltage of near 2A -- the peak to peak voltage.</p>
			<p>We might think to call our multiplier a voltage quadrupler, because it looks like two cascaded doublers... and maybe some people call it that. I prefer to call the 4 capacitor, 4 diode circuit a peak to peak doubler. The reason becomes clear when you consider different kinds of inputs. The first picture below shows node voltages using a sinusoidal input:</p>
			<img class="displayed" src="images/Flyswatter-sim-vm.PNG"/>
			<p>A is 10, and the output definitely approaches 4A... but look at the situation with a unipolar square wave input with a peak to peak variation of 20V:</p>
			<img class="displayed" src="images/Flyswatter-sim-vm-2.PNG"/>
			<p>The output aproaches the same value, while an amplitude which is half of the peak to peak value for this signal is not defined. I hope that clears that up.</p>

      <h2>Simulation</h2>

			<img class="displayed" src="images/Flyswatter-schematic-01.PNG" />
      <p>I have used a coupled inductor transformer model here, which assumes perfect coupling and no core losses--high and low estimated inductor values were chosen for a stepped simulation to observe sensitivity to these values. Copper losses are represented as the measured series resistances, specified for each inductor instance. A more detailed simulation with a non-ideal saturable transformer model will show up sooner or later. Also, I added D5 because it is irresponsible to allow EB breakdown. A transient simulation showing the high voltage output is right here below:</p>
      <img class="displayed" src="images/Flyswatter-transient-hv.PNG" />
      <h3>Red: L1=50u, L2=200m; Orange: L1=500u, L2=200m; Yellow: L1=50u, L2=2; Green: L1=500u, L2=2</h3>
      <p>A couple things to notice: L1 (primary inductance, as well as the first tap inductance of the secondary), has a strong effect on the oscillating frequency, and a relatively weak effect on output voltage (factor of 10 change in L gives 10-20% change in output voltage). The value of L2 seems to have a similarly week effect on the output voltage. Ok... so how does this thing oscillate? </p>
      <h2>Explanation</h2>
      <p>Let's fix the inductor values and observe terminal voltages and currents. Below is a transient simulation showing collector and base voltages and currents, as well as the voltage at the secondary tap:</p>
      <img class="displayed" src="images/Flyswatter-sim-regions.PNG" />

      <p>The smart thing to do is to recognize 4 time intervals: (1) switch open (2) switch closing (3) switch closed (4) switch opening. The switch open interval (1) is easily identified -- it is the one when collector current and base current are zero. The switch closed interval (3) is the one in which the collector current is increasing. <i>Interesting note, there is some funny behavior: For the first part of (3), collector current is negative, base current is large, and VE > VB > VC -- so here, the switch is in reverse active mode, with base current supplied through the clamping diode. The degree to which this occurs depends on the reverse active current gain of the transistor used -- we can ignore this for now.</i></p>
      <p>Now, what could cause the transistor to change its state from cutoff to saturated (2)? Consider the case in which power has not yet been applied and the switch is open. Upon applying power, the base sees a series resistor and inductor connected to the supply voltage. Obviously, the current into the base will increase from zero with an approximate L/R time constant, which will be in the hundreds of nanoseconds range -- pretty quick.</p>
      <p>Next, the switch enters state (3)--the interval of unbridled collector current increase. But something obviously bridals it... what is it? Well, there are a couple possibilities. Remember that the collector is in series with the transformer primary. By closing the switch, the primary is connected across the 3V supply, defining a rate of change of current:</p>
      \[\frac{di_L}{dt}=\frac{1}{L}V_L\]
      <p>The changing current will set up a proportional changing flux in the transformer core according to ampere's law:</p>
      \[I = \frac{mmf}{n},\,\,\,where\,\,\, mmf=\frac{\Phi}{P}\]
      <p>As long as this flux increases at that constant rate, the voltage across first secondary coil will be equal to that of the primary (the supply voltage), because of Faraday's law of induction:</p>
      \[\frac{d \Phi}{dt} = -\frac{V}{n}\]
      <p>As a side note, if the switch is saturated, forward current gain will be reduced, so it is expected that several milliamps will flow in the base to sustain the several hundred in the collector. Just 1mA will cause a voltage drop exceeding the supply across R1, but the BE junction will remain forward biased as long as a sufficiently large voltage appears across the secondary. But as was stated before, a reduction in the increase in flux will reduce that voltage. This could either be caused by a decrease in voltage across the primary (due to finite switch resistance), or transformer saturation. Either way, we should take some time to appreciate the double edged sword that is the turn-off interval./p>
      <p>Let's say either of the aforementioned mechanisms is responsible for a slight leveling off of the flux increase in the core. The secondary voltage then dips a bit, reducing the forward bias on the BE junction. This invariably will reduce the base current, which in turn will reduce the drop across R1, counteracting the reduction reduction of the BE voltage. This however, is not enough to keep the transistor turned on because the dip in base current will be reflected in the collector, further reducing the rate of increase of flux in the core. There we have our positive feedback -- reduction in collector current reduces BE voltage. And whatever else you need to know you can figure out.</p>
		</div>
</body>
</html>
